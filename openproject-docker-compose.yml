version: '3.8'

services:
  db:
    image: postgres:latest
    restart: unless-stopped
    stop_grace_period: "3s"
    environment:
      POSTGRES_PASSWORD: p4ssw0rd
      POSTGRES_DB: openproject
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - openproject

  cache:
    image: memcached:1.6
    restart: unless-stopped
    command: memcached -m 512M
    networks:
      - openproject

  web:
    image: openproject/openproject:12
    restart: unless-stopped
    environment:
      # Database configuration
      DATABASE_URL: "postgres://postgres:p4ssw0rd@db/openproject?pool=20&encoding=unicode&reconnect=true"
      
      # Cache configuration
      RAILS_CACHE_STORE: "memcache"
      OPENPROJECT_CACHE__MEMCACHE__SERVER: "cache:11211"
      
      # OpenProject configuration
      OPENPROJECT_SECRET_KEY_BASE: "secret"
      OPENPROJECT_HOST__NAME: "localhost:8080"
      OPENPROJECT_HTTPS: "false"
      
      # Email configuration (optional - configure for production)
      OPENPROJECT_SMTP_ADDRESS: "smtp.gmail.com"
      OPENPROJECT_SMTP_PORT: "587"
      OPENPROJECT_SMTP_DOMAIN: "gmail.com"
      OPENPROJECT_SMTP_USER_NAME: "githubcampusclubpsgct@gmail.com"
      OPENPROJECT_SMTP_PASSWORD: "tbog stni ojke sajl"
      OPENPROJECT_SMTP_ENABLE_STARTTLS_AUTO: "true"
      OPENPROJECT_SMTP_AUTHENTICATION: "plain"
      
      # Storage configuration
      OPENPROJECT_ATTACHMENTS_STORAGE_PATH: "/var/openproject/assets"
      
      # Additional configuration
      OPENPROJECT_DEFAULT_LANGUAGE: "en"
      OPENPROJECT_RAILS_RELATIVE_URL_ROOT: ""
      
    volumes:
      - opdata:/var/openproject/assets
    ports:
      - "8080:80"
    depends_on:
      - db
      - cache
    networks:
      - openproject

  # Optional: Web server proxy (uncomment if you want nginx proxy)
  # proxy:
  #   image: nginx:alpine
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - web
  #   networks:
  #     - openproject

volumes:
  pgdata:
    driver: local
  opdata:
    driver: local

networks:
  openproject:
    driver: bridge